<!DOCTYPE html>
<html>

<head>
    <style>
       body {
           background-color: lightblue;
       }
	   
	   .container-loading {
           width: 100%;
           height: 100%;
           display: flex;
           justify-content: center;
           align-items: center;
        }

        .container-loading img {
            width: 100px;
            height: 100px;
        }

	</style>
</head>
<body>
	<h1>DocxT</h1>
	
    <div id="upload_screen" style="visibility: visible">
	    
	    <div id="upload_screen_err" style="color: red"></div>
	    
		<div>
		    <form method="post" enctype="multipart/form-data" id="upload_form">
                <label for="file">Select docx template</label>
			    <br />
                <input id="file" name="file" type="file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"/>
                <br />
			    <button>Upload</button>
            </form>
		</div>
	</div>
		
	<div id="loading_screen" style="visibility: hidden" class="container-loading">
	    <img src="loading.gif" alt="loading" />
	</div>
	
	<div id="inputs_screen" style="visibility: hidden">
		<div id="inputs_screen_err" style="color: red"></div>
	    
		<div>
		    <form method="post" enctype="multipart/form-data" id="inputs_form">
				<div id="inputs_root">
				</div>

			    <button>Cancel</button>
				<button>Download</button>
            </form>
		</div>
	</div>


    <script>
    const form = document.getElementById("upload_form");
    form.addEventListener('submit', handleSubmitUpload);

     /** @param {Event} event */
    async function handleSubmitUpload(event) {
		event.preventDefault();
		const form = event.currentTarget
		
		showLoadningScreen()
		try {
            const fetchOptions = {
                method: "post",
			    body: new FormData(form),
            };

            const response = await fetch("/api/docx_template/upload", fetchOptions);
		    const json = await response.json();
		    if (!response.ok) {
			    showUploadScreen();
			    if (json != null)
			        document.getElementById("upload_screen_err").innerHTML = json.error;
			    return;
		    }
			
			if (json.structure)
			    showInputsScreen(json);
			else if (json.error) {
			    showUploadScreen();
			    document.getElementById("upload_screen_err").innerHTML = json.error;
			}
		} catch (error) {
		    console.log(error);
			showUploadScreen();
			document.getElementById("upload_screen_err").innerHTML = error;
		}
    }
	
	function showUploadScreen() {
		document.getElementById("upload_screen").style = "visibility: visile";
		document.getElementById("loading_screen").style = "visibility: hidden";
		document.getElementById("inputs_screen").style = "visibility: hidden";
		document.getElementById("upload_screen_err").innerHTML = "";
	}
	
	function showLoadningScreen() {
		document.getElementById("upload_screen").style = "visibility: hidden";
		document.getElementById("loading_screen").style = "visibility: visible";
		document.getElementById("inputs_screen").style = "visibility: hidden";
	}
	
	function showInputsScreen(json) {
		document.getElementById("upload_screen").style = "visibility: hidden";
		document.getElementById("loading_screen").style = "visibility: hidden";
		document.getElementById("inputs_screen").style = "visibility: visible";
		document.getElementById("inputs_screen_err").innerHTML = "";
		
		const inputsRoot = document.getElementById("inputs_root");
		if (!inputsRoot) {
		    console.log("Can't find: inputs_root");
			return;
		}
		recursiveFormImputs(inputsRoot, json.structure);
	}

	function recursiveFormImputs(element, structure) {
	    for (i = 0; i < structure.length; i++) {
			const inpEl = createStructureElement(structure[i]);
			element.appendChild(inpEl);
			
			const divForChildren = document.createElement("div");
			recursiveFormImputs(divForChildren, structure[i].children)
		}
	}
	
	function createStructureElement(structureElement) {
		const div = document.createElement("div");
		div.tag = structureElement;
		
		const label = document.createElement("label");
		 label.innerHTML = structureElement.name ? (structureElement.name + " (" + structureElement.tag + ")") : structureElement.tag;
         div.appendChild(label);
		 
		 if (structureElement.multiParagraph) {
		     const textArea = document.createElement("textarea");
			 div.appendChild(textArea);
		 } else {
			const input = document.createElement("input");
			input.type = "text";
			div.appendChild(input);
		 }
		 
		 if (structureElement.repeating) {
		    const addBtn = document.createElement("button");
			addBtn.innerHTML = "Add";
		    div.appendChild(addBtn);
		}
	}

	</script>
</body>
</html>