<!DOCTYPE html>
<html>

<head>
    <style>
       body {
           background-color: lightblue;
       }
	   
	   .container-loading {
           width: 100%;
           height: 100%;
           display: flex;
           justify-content: center;
           align-items: center;
        }

        .container-loading img {
            width: 100px;
            height: 100px;
        }

	</style>
</head>
<body>
	<h1>DocxT</h1>
	
    <div id="upload_screen" style="display: inline">
	    
	    <div id="upload_screen_err" style="color: red"></div>
	    
		<div>
		    <form method="post" enctype="multipart/form-data" id="upload_form">
                <label for="file">Select docx template</label>
			    <br />
                <input id="file" name="file" type="file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"/>
                <br />
			    <button>Upload</button>
            </form>
		</div>
	</div>
		
	<div id="loading_screen" style="display: none" class="container-loading">
	    <img src="loading.gif" alt="loading" />
	</div>
	
	<div id="inputs_screen" style="display: none">
		<div id="inputs_screen_err" style="color: red"></div>
	    
		<div>
		    <form method="post" enctype="multipart/form-data" id="inputs_form">
				<div id="inputs_root">
				</div>

			    <button>Cancel</button>
				<button>Download</button>
            </form>
		</div>
	</div>


    <script>
    const form = document.getElementById("upload_form");
    form.addEventListener('submit', handleSubmitUpload);

     /** @param {Event} event */
    async function handleSubmitUpload(event) {
		event.preventDefault();
		const form = event.currentTarget
		
		showLoadningScreen()
		try {
            const fetchOptions = {
                method: "post",
			    body: new FormData(form),
            };

            const response = await fetch("/api/docx_template/upload", fetchOptions);
		    const json = await response.json();
		    if (!response.ok) {
			    showUploadScreen();
			    if (json != null)
			        document.getElementById("upload_screen_err").textContent = json.error;
			    return;
		    }
			
			if (json.structure)
			    showInputsScreen(json);
			else if (json.error) {
			    showUploadScreen();
			    document.getElementById("upload_screen_err").textContent = json.error;
			}
		} catch (error) {
		    console.log(error);
			showUploadScreen();
			document.getElementById("upload_screen_err").textContent = error;
		}
    }
	
	function showUploadScreen() {
		document.getElementById("upload_screen").style = "display: inline";
		document.getElementById("loading_screen").style = "display: none";
		document.getElementById("inputs_screen").style = "display: none";
		document.getElementById("upload_screen_err").textContent = "";
	}
	
	function showLoadningScreen() {
		document.getElementById("upload_screen").style = "display: none";
		document.getElementById("loading_screen").style = "display: inline";
		document.getElementById("inputs_screen").style = "display: none";
	}
	
	function showInputsScreen(json) {
		document.getElementById("upload_screen").style = "display: none";
		document.getElementById("loading_screen").style = "display: none";
		document.getElementById("inputs_screen").style = "display: inline";
		document.getElementById("inputs_screen_err").textContent = "";
		
		const inputsRoot = document.getElementById("inputs_root");
		if (!inputsRoot) {
		    console.log("Can't find: inputs_root");
			return;
		}
		inputsRoot.textContent = '';
		
		recursiveFormImputs(inputsRoot, json.structure);
	}

	function recursiveFormImputs(element, structure) {
		if (!structure || structure.length < 1)
			return;

		const levelDiv = document.createElement("div");
		levelDiv.className = 'levelDiv';
		levelDiv.style = 'border:1px solid black;';
		element.appendChild(levelDiv);

	    for (let i = 0; i < structure.length; i++) {
			const inpEl = createStructureElement(structure[i]);
			if (!inpEl)
			    continue;
			levelDiv.appendChild(inpEl);


			if (structure[i].children && structure[i].children.length > 0) {
				const div = document.createElement("div");
				div.style = "margin-left: 30px";
				inpEl.appendChild(div);
				const divForChildren = document.createElement("div");
				divForChildren.className = 'divForChildren';
				div.appendChild(divForChildren);
				recursiveFormImputs(divForChildren, structure[i].children);
				
				
				if (structure[i].repeating) {
					const addBtn = document.createElement("button");
					addBtn.textContent = "Add";
					div.appendChild(addBtn);
					
					addBtn.addEventListener('click', async function(event) {
						event.preventDefault();
						recursiveFormImputs(divForChildren, structure[i].children);
					});
				
					const removeBtn = document.createElement("button");
					removeBtn.textContent = "Remove";
					div.appendChild(removeBtn);
					
					removeBtn.addEventListener('click', async function(event) {
						event.preventDefault();
						divForChildren.removeChild(divForChildren.lastChild);
					});
				}
			}
		}
	}
	
	function createStructureElement(structureElement) {

		const div = document.createElement("div");
		div.className = "structElement";
		div.tag = structureElement;
		
		const label = document.createElement("label");
		label.textContent = structureElement.name ? (structureElement.name + " (" + structureElement.tag + "): ") : structureElement.tag + ": ";
        div.appendChild(label);
		 
		if (structureElement.children && structureElement.children.length > 0) {
            return div;
		}

		const br = document.createElement("br");
		div.appendChild(br);

		if (structureElement.multiParagraph) {
		    const textArea = document.createElement("textarea");
			textArea.cols = 70;
			textArea.rows = 10;
			div.appendChild(textArea);
		} else {
			const input = document.createElement("input");
			input.type = "text";
			div.appendChild(input);
		}
		return div;
	}

	</script>
</body>
</html>